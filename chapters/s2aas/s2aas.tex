\chapter{Sensing-as-a-Service and Mobile Crowdsensing using Bitcoin}
\label{sec:datamarket}

We briefly introduced the Sensing-as-a-Service model in Sec. \ref{sec:micro:apps:s2aas} as an application for M2M micropayments. 
In this chapter, we will discuss Sensing-as-a-Service, and the related concept of mobile crowdsensing, in more detail.
We start by describing the significance of this model, and discuss the relevant characteristics of Bitcoin. Thereafter, we present a naive model that uses the Bitcoin network and blockchain as transport medium. We built several prototypical implementations with increasing level of sophistication. The 

\section{Introduction}

After investigating product, process and service innovation, scholars and industry experts have recently been shifting their focus on the innovation of business models, i.e. on how companies comprehensively reinvent the way they create and capture value for their customers \parencite{osterwalder2010business, zott2011business, pohle2006ibm, gassmann2013st,timmers1998business}. In a majority of game changing business model innovation in the last 15 years, information technology played a key role \parencite{gassmann2013st}. In that period, many new so called business model patterns where created in which information technology was a mandatory precondition. The first wave of the Internet, for example, created patterns such as \emph{Freemium}, \emph{E-Commerce}, \emph{Leverage Customer Data}, \emph{Long Tail}, and \emph{Digitalization}, the Internet 2.0 then led to patterns such as \emph{Crowdsourcing}, \emph{Crowdfunding}, and \emph{User Design}. 

Given that each Internet wave so far created new business model patterns one can assume that the same holds true for the next wave of Internet-based innovation, the IOT. The IOT is expected to consist of billions of sensor nodes bridging the gap between the physical and digital world. Hence, \emph{Sensing-as-a-Service} (S\textsuperscript{2}aaS) is a promising candidate for an IOT-enabled business model pattern \parencite{weinberger,perera2014sensing, mizouni2013mobile, sheng2013sensing}.  

In contrast to a physical good, a digital service attached to it by connectivity and sensing capabilities can easily be delivered not just to one addressee, but to many customers at the same time. In addition, these customers can be distributed across the globe. As a consequence, the one who generates the data is not necessarily the one who profits from the data. Thus physical goods that help to create data initiate multi-sided markets for sensor data in which one or more customer groups (the market’s buying side) subscribe to and pay for data that is provided by one more data creator (selling side). For instance, car manufacturers could be interested in a constant flow of road condition data generated by all cars on the street, city planners in the way how bicycles move through town, parking authorities and car drivers in empty parking lots, companies that produce weather forecasts in the data of millions of privately owned weather stations, and home security systems in the data generated by heating and climate control systems.

The technical challenges when building such a S\textsuperscript{2}aaS business model pattern are manifold: For instance, sensors and its owners have to be uniquely identified and authenticated, the values delivered by the sensors should be traceable and have to be secured against manipulation, and a low cost micropayment system has to enable the seller side to receive monetary gratification from the buyer side — because not everybody will be willing to share his sensor data for free. But even more than technical challenges, economic and business aspects are central to the success of S\textsuperscript{2}aaS \parencite{bohli2009initial} given the inherent chicken-and-egg problem that is typical for patterns based on network effects. In this paper, we present the key characteristics of Bitcoin -- a peer-to-peer payment system and a digital currency -- and discuss how these characteristics could contribute to enable and establish  S\textsuperscript{2}aaS business model patterns.

\section{Background}

\subsection{Crowdsensing and Sensing-as-Service}
\label{sec:crowdsensing}

Crowdsensing is where individuals with sensing and computing devices collectively share data and extract information to measure and map phenomena of common interest \cite{ganti2011mobile}. Predominately, crowdsensing has been engaged in the form of mobile crowdsensing, utilizing the ubiquity of smartphones, in application-specific scenarios. Examples are transit tracking \cite{Thiagarajan:2010:CTT:1869983.1869993}, road and traffic monitoring \cite{Mohan:2008:NRM:1460412.1460444}, site characterization \cite{Chon:2012:ACP:2370216.2370288}, and on-street parking \cite{Chen:2012:COS:2386958.2386960,6569416}. Besides these small-scale academic field studies, notable examples for successful large-scale, application specific mobile crowdsensing application are Google Maps and Waze which was acquired by Google in 2013.   

\cite{guo2015mobile} provide an extensive recent review of the various mobile crowdsensing paradigms, their applications, as well challenges and opportunities. 
The main challenges that have been identified repeatedly (see also \cite{he2015privacy}) are privacy and incentives. \cite{Christin2015} provides an analysis of the privacy implications and threats as well as a survey of available privacy-preserving techniques. 

In the application-specific scenario participants are typically incentivized by receiving an application-specific service. In the case of Google Maps a participant gets routing and traffic information in exchange for providing location and speed information. Especially in the case of participatory sensing where explicit user input is required gamification \cite{Deterding:2011:GDE:2181037.2181040} has been used successfully (e.g. Waze) to incentivize participation. However incentivization by service provision leads to contribution only from users who are in need of that particular service and only during specific times. In contrast monetary incentives are a general purpose incentive mechanism. Thus far monetary incentives have mostly been studied in small-scale, localized field studies, as well as in form of game-theoretic incentive mechanism design \cite{7101300}. 
Related to crowdsensing, there is also sensing as a service model \cite{Sheng:2013cm,ETT:ETT2704}, which emphasizes the ad-hoc access to sensing infrastructure or real-time data without investing in infrastructure itself. The sensing as a service model can be seen as an extension of the crowdsensing model to incorporate commercial sensor networks.

In recent years a multitude of architectures enabling general purpose crowdsensing and sensing as a service applications have been presented \cite{6558754,6525603,giannotti2012planetary,Haderer2015,merlino2016mobile}. However none of them has reached reasonable scale.

What has been mainly neglected is how monetary incentives can be provided efficiently under the conditions of a global mobile crowdsensing platform. 
Individual rewards are rather small and data requesters as well as data providers might be distributed globally. Furthermore traditional online payment mechanisms provide additional means for de-anonymization of participants. 

\section{Bitcoin Characteristics with Relevance for S\textsuperscript{2}aaS}

\subsection{Decentralization and Openness}

Comparable to HTTP as a protocol for transfer of data, Bitcoin is a protocol for the transfer of cash on the Internet. It is based on a decentralized design and consequently has no single point of trust. Just like HTTP, anyone is free to use it and build applications on top of it. This has important ramifications for its use in S\textsuperscript{2}aaS applications.

As Bitcoin is a peer-to-peer network, it is censorship-resistant. Consequently, no central authority can systematically exclude someone or something from participating. This represents a crucial difference to classical payment networks (e.g. Visa, MasterCard, or PayPal) that can ban anyone from using their services (as happened to Wikileaks in 2010 and Russian bank customers in 2014). Using Bitcoin as payment layer for S\textsuperscript{2}aaS application brings censorship-resistance to sharing sensor data for cash payment. Nobody could systematically be excluded to buy or sell sensor data.

Without counter-party risk of an intermediary to process both payments and data transfer, applications leveraging on a Bitcoin enabled S\textsuperscript{2}aaS  environment do not carry the risk of self-interested (even justified) policy changes by central entities. For instance, policy changes by Twitter forced some third-party developers using the Twitter API to shut down their operations \parencite{twitterAPI}. Something like this cannot happen using Bitcoin, as there is no central authority able to change the rules out of self-interest. Using Bitcoin as a payment network is completely platform independent. This should give entrepreneurs, sensor data providers (like the personal weather station owners in our example) and established platforms alike confidence in the stability, longevity and availability of S\textsuperscript{2}aaS services built on top of the Bitcoin protocol and stir innovation.

Further, Bitcoin is an open source project with many readily available implementations that can be adapted and extended\ bitcoin.org/en/development for a list). Anyone is free to use Bitcoin technology and innovate with it. This gives Bitcoin a head start for innovation which will continue to grow rapidly all areas that require some sort of financial service, like payment, including S\textsuperscript{2}aaS applications.

\subsection{Pseudonymous Identification}

A viable S\textsuperscript{2}aaS network requires that all entities have  to be  uniquely  identified  and  authenticated. Bitcoin addresses can be assigned to all types of entities in a S\textsuperscript{2}aaS network. Ownership of an address is provable with public key cryptography and allows for pseudonymous authentication.

As Bitcoin addresses are not directly connected to an identity and do not need to be registered at some central entity in the network, they guarantee pseudonymity of the owner. This can be favorable for S\textsuperscript{2}aaS applications, because data providers may not want to expose their identity. However, it does not necessarily mean that owners are anonymous. As all transactions are publicly available on the block chain, any payment can be traced to an address that can possibly be connected to an identity at some point.

Bitcoin addresses cannot only be assigned to persons and used as an equivalent to a bank account. Objects like cars, fridges, houses and - like in our example -- personal weather stations -- can have a Bitcoin address, effectively enabling them to send and receive cash. As the Bitcoin network does not incorporate any intermediaries, Bitcoin transactions can be carried out completely automated. In fact, Bitcoin transactions can be carried out equally well by machines and humans enabling direct machine-to-machine payments. We believe, this will have strong impact on future S\textsuperscript{2}aaS applications and the IOT in general.

\subsection{Low Fees and Friction}

Bitcoin is a global payment network enabling cash transactions from anyone (or anything) to anyone (or anything) at any time directly without the need for an intermediary. Thereby, Bitcoin can scale down payments to very low amounts allowing for trade of very small exchangeable units. We believe, low fees and friction in the Bitcoin payment network can lead to a whole wave of IOT innovations, because the programmatic exchange of arbitrary amounts of cash without human intervention and intermediaries allows for a generation of IOT applications that has not been feasible before.

Using Bitcoin technology as a payment network for S\textsuperscript{2}aaS applications may allow for purchases of single data points, as in our basic example of a personal weather station, costing way less than the smallest available units of any traditional currency. This would not be possible using traditional payment network, at least not without the introduction of additional processes. Typical intermediaries in a classical payment network like Visa, MasterCard collect fees of one to three percent \parencite{chakravorti2003theory}. Average fees for international remittances (e.g. with Western Union or MoneyGram) even account for more than eight percent of the transaction amount \parencite{remittances}.

Bitcoin transactions are not free, but rather compete against each other for space in the block chain in something similar to a bidding process. Senders of Bitcoin transactions can include a voluntary, so called miner fee with their transactions. Transactions with higher fees are given higher priority by miners and are consequently processed faster than transactions with lower fees (This is a simplified description. For an accurate description of the transaction prioritization mechanism, please refer to \parencite{bitcoinwiki, nakamoto2008bitcoin}). By exposing Bitcoin transactions to these simple supply and demand market dynamics transaction costs are no longer dictated by the gatekeepers of payment networks and price efficiency in the processing of transactions for all types of applications will eventually be established.

\subsection{Scriptability}
\label{subsec:script}

Bitcoin is programmable money in the sense that transactions are scriptable. For instance, the validity of a transaction message, and hence its clearing, can be bound to certain conditions. By combining multiple transaction messages and conditions, rather complex contracts requiring no trust between the parties can be established. Traditionally such contracts are enforced by intermediaries. Bitcoin allows to establish contracts and enforce them completely without intermediaries in the block chain. The following examples are taken from \cite{smartcontr}. We briefly describe the different types of scripted transactions and put them into context to S\textsuperscript{2}aaS.

\subsubsection{Cryptographic Verifiability}
Bitcoin uses digital signatures to prove ownership of addresses. Using the same technique, persons, or in our case sensors, can authenticate themselves by signing a message, proving ownership of their Bitcoin address. Confidentiality of the data to be sent can be guaranteed by encrypting the data with the public key of the receiver. Further, the block chain can be used as a notary service for the transacted data. Hashes of the data can be stored in the block chain to prove that the data was not altered later on.


\section{Motivating Example}

To illustrate the here presented concept, we use a personal connected weather station like Netatmo \parencite{netatmo} as an example. Personal weather stations are typically equipped with multiple sensors to continuously measure, for instance, temperature, humidity, wind speed, wind direction, solar radiation, and air pressure. Some even measure air pollution in terms of particulate matter which concerns people's health. The most obvious use for this data is to inform the owner of the weather station with the data it generates. Another example for the application of measurement data from a weather station is its use to feed the control system of the owner's household heating. For the investment into a personal weather station and heating control, its operation and maintenance, the owner gains the benefit of a well-tempered house and saves energy and money \parencite{dong2014real}. 

Clearly, there is more overall use to the data, if it is shared with others. For instance, neighbors could use the exact same data to control their heating systems, however, only given the condition that the owner of the weather station is willing to share the generated data. Even for the rather simple case of a weather station, there are many other useful applications of the data. Fitness platforms like Runkeeper\footnote{https://www.runkeeper.com} and Nike+\footnote{https://nikeplus.nike.com} could aggregate data from many owners of personal weather stations to monitor air pollution and generate running tracks with optimal air quality in real-time. Meteorologists could improve weather forecasts with the high-resolution data from many personal weather station owners. Also, researchers could use the data to track climate change \parencite{JOC:JOC1276}.

There are already enthusiasts who share their data freely and without monetary incentive, e.g. \parencite{wunderground.com}. However, to enable applications of greater use, there has to be extensive supply of sensor data from many weather stations all around the world. This can only be achieved by providing monetary incentive to the suppliers \parencite{bohli2009initial}. In fact, monetary incentivization of sensor data providers is a main challenge faced by S\textsuperscript{2}aaS schemes to become viable in the future. As outlined above, Bitcoin technology embodies characteristics that could help to tackle those challenges. Thus far, scholars proposing S\textsuperscript{2}aaS have always introduced central coordinating intermediaries \parencite{bohli2009initial} such as sensor publishers \parencite{perera2014sensing} or sensor cloud platforms \parencite{sheng2013sensing}. 
In the following, a completely decentralized scheme using the Bitcoin protocol is presented. First, the atomic process of exchanging a single sensor datum between two machines for cash is introduced. Limitations and extensions towards scalable implementations are discussed thereafter in Section \ref{subsec:extensions}

\section{Basic Concept}

Consider the scenario in which two machines trade a single datum for cash. The simplified process is illustrated in figure \ref{fig:btcDataExchange}, for a more in detail technical introduction please refer to \parencite{bitcoinwiki, nakamoto2008bitcoin}. Given the example above the requesting machine A could be the Nike+ smartphone application which requires the current air pollution at the user's typical running track to optimize air quality during the run. The sensor C in this case would be an air pollution sensor in the vicinity of the running track. Both, the requesting machine and the sensor have a key pair which provides unique identification and allows them to transfer cash as well as private data over the block chain B as the decentralized public ledger. 
In the illustrated scenario, the requesting machine A sends a payment to the Bitcoin address (the public key\footnote{More precisely the SHA-256 hash of the public key plus a prefix.}) of sensor C. This involves the generation of a transaction that gets included in the block chain (1). In a second step, sensor C notices the receipt of the payment (2). After that, sensor C creates a transaction to the Bitcoin address of requester A, including its most current datum encrypted with A's public key  (3). Finally, requester A notices the receipt of the transaction that includes the requested datum and decrypts it using its private key (4).

\begin{figure}
\centering
\includegraphics[width=\textwidth]{./externalized/btcpro3.png}
\caption{Schema for the atomic  S\textsuperscript{2}aaS process of exchanging a single datum for cash using Bitcoin.}
\label{fig:btcDataExchange}
\end{figure}

\section{Prototype I: Naive Implementation}

\subsection{Architecture}

Our system consists of three parts. A sensor client, a requester client and a sensor repository. How these parts interact with each other and with the Bitcoin network is illustrated in Fig. \ref{fig:process}.

% \marginpar{
\begin{figure}
\begin{center}
\includegraphics[width=\columnwidth]{./externalized/s2aas.pdf}
\caption{Process for exchanging data for bitcoin.}
\label{fig:process}
\end{center}
\end{figure}
% } 

\paragraph{Sensor Client}
The sensor\footnote{Here, we understand a sensor as a complete system entailing a sensing unit and a computing unit with Internet connectivity. However, they may not be in a single device.} client needs to fulfill the following tasks. It needs to note a data
request by receiving bitcoins and it needs to be able to create and publish a
transaction containing the requested data.

\paragraph{Requester Client}
The requester client needs to be able to send bitcoins to the sensor's Bitcoin
address. Further, it has to note the subsequent transaction of the sensor
containing the requested data.

\paragraph{Sensor Repository}
In addition, we propose a sensor repository where sensors can be registered in
oder that they can be found by requesters. An entry in the sensor repository should
contain at least the Bitcoin address, which data it offers, the price, and
additional meta data like location, tags, etc.

\subsection{Implementation}

\paragraph{Sensor Client}
In order to note a payment and therefore a data request, we implemented a websocket
client which registers with a websocket API. The websocket server relays transactions containing
the sensor's Bitcoin address. Subsequently the transaction is parsed for the 
requester's Bitcoin address. In the general case, there might be multiple inputs
with different addresses. However, in this first implementation we assume that the
requester uses only a single bitcoin address for spending. Thereafter, a transaction
with a P2PKH output containing the requester's Bitcoin address and a
unspendable output containing the current measurement data is created and published
to the Bitcoin network. 

\paragraph{Requester Client}
The requester client retrieves sensors from the sensor repository. The user then selects the desired sensor and a payment is made to the sensor's Bitcoin address. Another websocket client waits for the transaction from the sensor entailing the data. On arrival, the data is decoded and presented to the user.

\paragraph{Sensor Repository}
The sensor repository is implemented as a database with a RESTful HTTP API and
a web front end. Both can be used to register a sensor or to search for a sensor.
An example for a sensor search would be to search for a keyword and a location.
The response then entails a list of sensors meeting those criteria.

\subsection{Evaluation}

\section{Prototype II: Datamarket based on the 21 Bitcoin Computer}

The system is based on the 21 Bitcoin Computer which provides two important features that simplify the implementation significantly. First, a library is provided that allows to integrate Bitcoin-payable HTTP REST endpoints. Payments can either be made on- or off-chain. Off-chain payments are handled by 21 internally and therefore allow instant micropayments below Bitcoin's dust limit (currently 576 satoshi\footnote{Satoshi is the smallest fraction of a bitcoin. 1 satoshi corresponds to $10^{-8}$ bitcoin.}) and without fees. Hence, we sacrifice direct peer-to-peer payments, at least for the moment, in exchange for the possibility to handle individual payments as tiny as 1 satoshi. Second, each 21 Bitcoin Computer is already part of a virtual network enabled by software defined networking. Thus, peer-to-peer communications, e.g. for data delivery, between requesters and providers are directly possible. 

\subsection{Architecture}

\subsection{Implementation}

% \begin{figure}
% \begin{center}
% \includegraphics[width=0.7\textwidth]{datamarket.pdf}
% \caption{General architecture of the data market artifact.}
% \label{fig:system}
% \end{center}
% \end{figure}

\
A graphical representation of the system is shown in figure \ref{fig:system}. In the following we will briefly describe the individual components.
\subsubsection{Sensor registry}
\label{sec:registry}
The sensor registry provides the means of discovery for data providers and data requesters. Notably, discovery between requesters and providers could be implemented on top of a distributed hash table like Blockstack\cite{blockstack}. However, we chose a centralized registry based on a MongoDB for practical reasons. Data providers are able to publish their offerings on the data market by creating an entry in the sensor registry. This is currently done with the command line interface, which will be presented in Section \ref{sec:cli}. Entries in the sensor registry have the following form\footnote{Additional fields such as accuracy or measurement interval might be available.}
\begin{lstlisting}[basicstyle=\ttfamily\tiny]
{     
    "name": "Air Quality Zurich Downtown"
    "endpoint" : "http://10.147.17.77:3002/measurement",
    "datatype" : "int",
    "type"     : "co2",
    "unit"     : "ppm",
    "price"    : 10,
    "location" : "47.37246913,8.54426892"
    "description": "Zurich air quality measurements"

}
\end{lstlisting}
and can be queried using the datamarket command line interface. Entries also have a time-to-live (TTL) after which they expire. TTL can be extended by payment. This provides a revenue stream for the data market provider and should lead to a higher fraction of available data providers. 
\subsubsection{Data provider}
A data provider is represented by a simple HTTP webserver with a payable API endpoint that returns a measurement value and a timestamp as JSON. Since the 21 Bitcoin Computer is essentially a Raspberry Pi physical sensors can be attached easily. Moreover it can act as bridge to external sensor data. An example would be an endpoint which is fed by a MQTT consumer.
\subsubsection{Datamarket command line interface}
\label{sec:cli}
The datamarket command line interface provides access to the functions of the data market. Figure \ref{fig:cli} shows the help screen where all functions are listed. In the next section we will present a step-by-step guide through the functions.
\begin{figure}
\begin{center}
\includegraphics[width=0.7\textwidth]{./externalized/cli.png}
\caption{Help screen of the datamarket command line interface provides an overview of its functions.}
\label{fig:cli}
\end{center}
\end{figure}





\subsection{Evaluation}
\label{sec:eval}
In the following, we will use the datamarket artifact to offer real-time data of air quality measurements in Zurich.
We assume a 21 Bitcoin Computer with a CO$_{2}$ sensor, which acts as a proxy for air quality, attached and the datamarket cli installed. The sensor.py represents the actual webserver that will serve the measurement data upon payment. Thus, sensor.py has to be configured to access and serve the measurement data. Furthermore the configuration file config.json which provides essentially the sensor registry entry as presented in Section \ref{sec:registry} has to be adapted. After that we are ready to publish the sensor on the data market with
\begin{lstlisting}[basicstyle=\ttfamily\small]
datamarket publish --hours 72
\end{lstlisting}
The hours option defines how long the entry will stay valid. To start up the webserver and serve measurement data to potential data requesters we type
\begin{lstlisting}[basicstyle=\ttfamily\small]
datamarket open
\end{lstlisting}
Now a potential requester can query the datamarket to find this offering by using
\begin{lstlisting}[basicstyle=\ttfamily\small]
datamarket query '{"type": "co2", "location:"Zurich"}'
\end{lstlisting}
which will return matching sensors. The current measurement value can then be bought directly from a sensor node either using the returned id or the endpoint url. Here we use the id.
\begin{lstlisting}[basicstyle=\ttfamily\small]
datamarket buy '56698e32961b6b64b473e71c'
\end{lstlisting}
If funds are sufficient the current measurement value is returned along with a timestamp.

\section{Prototype III: Mobile Crowdsensing with Mediated Payment Channels}

\subsection{Architecture}

he system consists of three main components. A data requester or data buyer application, a data provider application, and a hub application. In order to fulfill the aforementioned principles the payment of the measurement data is done by means of N-to-M mediated payment channels as presented in Section \ref{sec:mediated} where the hub acts as the mediator over which payments are routed. At the same time the hub provides a query-able data provider registry. Noteworthy, the consolidation of payment routing and registry slightly violates our third design principle. However, both components are logically separated. An illustration of the system's architecture is shown in Figure \ref{fig:architecture}.


 \begin{figure}
 \includegraphics[width=\textwidth]{./externalized/Architecture.pdf}
 \caption{Overview of system's architecture.}
 \label{fig:architecture}
 \end{figure}

\subsection{Implementation}

The implementation of N-to-M mediated payment channels is based on extending the payment channel implementation of the bitcoinj library \cite{Bitcoinj}. Bitcoinj is a Java library for working with the Bitcoin protocol and was the first Bitcoin library that had implemented support for payment channels. The Java implementation was chosen because it allows to reuse the implementation across all of the system's components. JavaScript provides the same benefits but libraries were not as mature at that point. Furthermore, bitcoinj implements simplified payment verification (SPV). It allows to verify on-chain transactions without needing to store and verify the entire Bitcoin blockchain. SPV nodes store only the block headers (80 byte instead of a few hundred kilo byte for a typical block), and rely on the depth of a transaction in the blockchain. Block headers contain the root of a Merkle tree that is built of all transaction hashes in the block. Hence, in order to validate a particular transaction, a SPV node has to retrieve only a subset of the block data, i.e. the corresponding branch of the Merkle tree.
Only due to the SPV is it viable to use Bitcoin on resource constrained devices without trusting third party services.

The data requester and the hub are implemented as native Java applications. The data provider is implemented as an Android application. Before presenting the implementation of the individual components we start with the common building block on which all peer-to-peer payments are based. 

\paragraph{Mediated payment channels using HTLCs}

We follow the client-server architecture of the payment channel implementation of bitcoinj \cite{BitcoinjPC}. A client is always on the sending side of a payment while a server is on the receiving side (c.f. Figure \ref{fig:architecture}). Since the hub acts as mediator or router for payments between requesters and providers it has to receive payments from requesters and forward those payments to providers. Hence, the hub incorporates both, server and client.

\begin{table}
  \centering
    \caption{The five layers of the HTLC payment channel implementation.}
  \begin{tabular}{|c|l|}
    \hline
    \tabhead{Layer} &
    \tabhead{Description} \\
    \hline
    Driver Application & \multicolumn{1}{|p{0.5\columnwidth}|}{Provides the API to access lower layers}\\
    \hline
    Channel Connection & \multicolumn{1}{|p{0.5\columnwidth}|}{Provides the interface to the network}\\
    \hline
    Payment Channel & \multicolumn{1}{|p{0.5\columnwidth}|}{Handles messages from/to the network and passes instructions/gets results to/from the lower layer}\\
    \hline
    Channel State Machine & \multicolumn{1}{|p{0.5\columnwidth}|}{Handles the state of the payment channel}\\\\
    \hline
    HTLC State Machines & \multicolumn{1}{|p{0.5\columnwidth}|}{Handles the state of the HTLC}\\\\
    \hline
  \end{tabular}
  \label{tbl:layers}
\end{table}

In order to implement hashed HTLCs we extended the four layers of bitcoinj's payment channel implementation with a fifth layer that is concerned with keeping track of the HTLC flow. The five layers are described briefly in Table \ref{tbl:layers}. Details about the state machines and sequence diagrams can be found in BLINDED FOR REVIEW.
Messages and transactions are serialized using Google protocol buffers\footnote{https://developers.google.com/protocol-buffers/} and are exchanged between the components over TCP connections. The payment channel setup and the HTLC payments in the implementation are slightly more complex and involve even more communication than it is shown in Table \ref{tabl:htlcflow} because we use the interactive approach for channel refunds. 

\paragraph{Data provider}

The data provider is implemented as an Android application. The application allows users to offer measurement data from various sensors at an adjustable price denominated in satoshis\footnote{A satoshi is the smallest fraction of a bitcoin and corresponds to $10^{-8}$ bitcoins}. Table \ref{tbl:sensors} provides an overview of possible sensors. With the initial boot of the application, a local wallet is generated. The wallet is responsible for generating and storing key pairs and signing transactions. Furthermore a background service is started that manages the payment channel server and data delivery. If a user decides to offer measurement data from a specific sensor, the application registers the sensor at the global sensor registry. The initial registration then triggers the setup of a payment channel between the hub and the Android application. As soon as the payment channel is established the application is ready to serve requests from buyers.


\begin{table}
  \centering
  \caption{Examples of virtual and physical sensors available in smartphones.}
  \begin{tabular}{|c|l|l|}
    \hline
    \tabhead{Sensor} &
    \tabhead{Type} &
    \tabhead{Application} \\
    \hline
    Barometric pressure & physical & Weather prediction \\
    \hline
    Location & both & People flow  \\
    \hline
    Network strength & physical & Coverage maps \\
    \hline
    Installed apps & virtual & Inter-app correlations    \\
    \hline
    Transportation mode & virtual & City monitoring \\
    \hline
    Steps & virtual & Health monitoring  \\
    \hline
  \end{tabular}
  \label{tbl:sensors}
\end{table}


\paragraph{Data requester}
The data requester is implemented as a Java application. The requester application allows to query the sensor registry. In the prototype this is achieved using simple console commands. Table \ref{tbl:commands} shows the available commands.

\begin{table}
  \centering
    \caption{Available commands of the data requester console.}
  \begin{tabular}{|c|l|}
    \hline
    \tabhead{Command} &
    \tabhead{Description} \\
    \hline
    STATS NODES & Returns all connected sensor nodes \\
    \hline
    STATS SENSORS & Returns available sensor types \\
    \hline
    SELECT SENSOR=$<$type$>$ & \multicolumn{1}{|p{0.5\columnwidth}|}{Returns sensors of type $<$type$>$ with pricing information} \\
    \hline
    BUY $<$type$>$ FROM $<$node$>$ & \multicolumn{1}{|p{0.5\columnwidth}|}{Buys the current measurement value of sensor $<$type$>$ from node $<$node$>$} \\
    \hline
   
    \hline
  \end{tabular}
  \label{tbl:commands}
\end{table}



\paragraph{Hub}
The hub acts as the central point of coordination. Data providers register their sensors with the sensor registry that the hub provides, and data requesters are able to query the registry. Furthermore, the hub is responsible for mediating the payments between buyers and sellers. The hub instantiates a payment channel client and a payment channel server

\subsection{Evaluation}

\subsubsection{Conceptual Evaluation}

\paragraph{Low barrier for participation}
A potential participant on the data provider side has to download and install the data provider smartphone application. The data provider does not need to own any bitcoins. Furthermore no manual sign-up or registration is required. This means also the system has global reach and could provide a low-income stream to smartphone users in developing countries.

A data requester does not have to register but the wallet of the data requester application needs to have some amount of bitcoin in order to initiate a payment channel with the hub.

\paragraph{Incentivize participation with micropayments}
Individual payments can be as low as 1 satoshi. In April 2016, the exchange rate is around 450\$/BTC. In regard to this exchange rate individual payments can be as low as 4.5 $\mu$\$. Even smaller payments could be implemented with probabilistic payment schemes \cite{Rivest1997,Pass:2015:MDC:2810103.2813713}. Transaction fees for setting up and closing payment channels will be discussed in Sec. \ref{sec:fees}. 

\paragraph{Limited trust in hub provider}
The usage of HTLCs to interconnect payment channels of data providers and data requesters allows atomic payments between those parties. This means either the payment happens in both channels or it happens not at all. 

\paragraph{Anonymity}
Obviously there is a risk of de-anonymization for data providers depending on the data they are selling. For example selling of location data or wifi SSIDs could be used to identify a data provider. We restrict the evaluation of anonymity to the payment aspect. Bitcoin payments themselves are pseudonymous. Transactions only entail cryptographic public keys or hashes thereof. If users . In addition, due to the usage of mediated payment channels, there is no public link between buyers and sellers. Only transactions between buyers and the hub, and sellers and the hub end up in the blockchain. Transactions entailing the linking secret are kept private. 

In addition, there is a risk of de-anonymization based on the IP addresses. However since all communications are based on TCP, it would be possibly to run the system over Tor\footnote{https://www.torproject.org/}.


\subsubsection{Empirical Evaluation}

\paragraph{Performance}

For setting up and closing of payment channels the Bitcoin network itself is dictating the performance. If fees are sufficient a transaction can be assumed to be included in the blockchain in 10 min on average. Depending on the value of the transaction the receiver of the funds might wait until the transaction has six confirmations. This means that there are five additional blocks on top of the block entailing the transaction. 
In the following we assume that payment channels are already in place and evaluate the time is takes to complete a payment. The experiment was done by instantiating 100 data requesters and one data provider. Each requester buys one measurement value from the data provider. Table \ref{tbl:performance} shows a breakdown of the mean times and the standard deviation according to the payment steps. The results request some explanation. First, the HTLC setup process between hub and provider seems to take almost twice as long as the the HTLC setup between requester and hub. The reason for this is that the hub-provider setup is initiated with generating the secret but then has to wait until requester-hub setup is finished. If the hub would initiate the HTLC setup with the provider immediately the hub would risk paying the provider without being able to pull the respective funds from the requester. Second, the teardown process (i.e. updating the setup transacting by assigning the value of HTLC output to the payee.) takes less than half the time of the setup process. The reason for that is mainly that in the actual implementation the interactive refund approach was used. This means that there is an additional transaction which has to be signed by both parties and has to be transferred from payer to payee and back. Thus, we expect a comparable performance between setup and teardown if the non-interactive approach is used. Furthermore, we see that the steps that involve the provider take more time. This is because signing and signature verification are computation intensive tasks and the data provider is a comparably weak smartphone.

\begin{table}
\centering
\caption{Payment duration breakdown}
\begin{tabular}{|l|r|r|}
\hline
{\textbf Payment } & \multicolumn{1}{l|}{{\textbf Mean}} & \multicolumn{1}{l|}{{\textbf St. Dev.}} \\ \hline
Requester-Hub setup             & 479.3 ms                 & 78.8 ms                      \\ \hline
Hub-Provider setup            & 1015.1 ms                & 151.4 ms                     \\ \hline
Hub-Provider teardown         & 199.6 ms                 & 68.3 ms                      \\ \hline
Buyer-Provider teardown          & 146.6 ms                 & 10.1 ms                      \\ \hline
\end{tabular}

\label{tbl:performance}
\end{table} 


\paragraph{Transaction costs}
\label{sec:fees}
Transaction fees in Bitcoin are in principle voluntary. The party that creates a transaction specifies the transaction fees as the difference of the sum of the value of all inputs and the sum of the value of all outputs. However, each miner can decide individually if she will accept the transaction for a candidate block. Since there is a limit on the maximum size of a block, and larger blocks need more time to propagate the network, rational miners will select transactions with higher transaction fees. This is also the reason why transaction fees are based on the size of the transaction instead of its value. The transaction size is mainly defined by the number and size of input and output scripts and signatures. Figure \ref{fig:tx_fees} shows the daily averages of transaction fees in USD/kb for the period of one year.

\begin{figure}[!t]
\centering
\includegraphics[width=\textwidth]{./externalized/fees_per_kb}
\caption{Bitcoin transaction fees in USD/kb. Each point represents a daily average.}
\label{fig:tx_fees}
\end{figure}


\begin{table}
  \centering
  \caption{Approximate sizes and costs for Bitcoin transactions}
  \begin{tabular}{|c|l|l|}
    \hline
    \tabhead{Transaction Type} &
    \tabhead{Size} &
    \tabhead{Cost} \\
    \hline
    Standard P2PKH & \multicolumn{1}{|p{0.5\columnwidth}|}{} & \\
    \hline
    Funding & \multicolumn{1}{|p{0.5\columnwidth}|}{} & \\
    \hline
    HTLC setup & \multicolumn{1}{|p{0.5\columnwidth}|}{} & \\
    \hline
    Settlement & \multicolumn{1}{|p{0.5\columnwidth}|}{} & \\
    \hline
    Forfeiture & \multicolumn{1}{|p{0.5\columnwidth}|}{} & \\
    \hline
  \end{tabular}
  \label{tbl:fees}
\end{table}



\section{Discussion}
\label{sec:s2aas2_discussion}

In this section, we revisit the S\textsuperscript{2}aaS relevant characteristics of the Bitcoin protocol introduced in table \ref{table:characteristics} and discuss their application to S\textsuperscript{2}aaS schemes. 

The core Bitcoin protocol is continuously improved and extended by a vibrant open source community. Developers are actively adapting the core protocol to the needs of the rapidly growing ecosystem. As the Internet was not originally designed for the applications that we use today, it still evolved on top of the original underlying protocols like TCP/IP and HTTP. For this reason we choose not to focus on specific single technical limitations of the current Bitcoin protocol implementation, but rather argue from a broader technological perspective.



\section{Conclusion}

The IOT is expected to consist of billions of sensor nodes bridging the gap between the physical and digital world. Based on the idea that not only the one who generates data can profit from it, the concept of S\textsuperscript{2}aaS foresees global sensor data markets. However, to carry this idea from theory to practice, there are manifold systemic hurdles to overcome. Naturally, a low cost micropayment system for sensor data has to be in place, so sellers of data are able to receive monetary gratification from the buyer side. Sensors and its owners have to be uniquely identified and authenticated and values delivered by the sensors should be traceable and have to be secured against manipulation. 

In this paper, we introduced Bitcoin with its core characteristics and discussed how IOT applications and more specifically S\textsuperscript{2}aaS applications could benefit from Bitcoin technology or its conceptual idea. We derived five core characteristics that could drive innovation in this context: (1) decentralization and openness, (2) pseudonymous identification, (3) low fees and friction, (4) scriptability, and (5) cryptographic verifiability. We discuss how the integration of these characteristics in S\textsuperscript{2}aaS applications may trigger the right business dynamics that are needed on the buyer side and on the seller side of emergent sensor data by creating value for all exchange partners that is solely based on fair market dynamics defined in the underlying protocol. 

As the eco-system around Bitcoin is growing and its technology and conceptual idea has already been transferred successfully to other domains and purposes, it is our belief that it could also drive the development of S\textsuperscript{2}aaS business models. These could build on the innovations that the integration of discussed characteristics provides and offer new value propositions. It is our intent to start the conversation with IOT scholars and practitioners. From our perspective, future research should focus on bringing Bitcoin and the IOT closer together in two ways. First, by further refining the core characteristics of Bitcoin in the IOT context and eventually building a framework for IOT applications to further understand Bitcoin's potential role in its evolution. Second, by conceptualizing IOT applications using Bitcoin, solving known problems and inventing new applications.

